# sing-box-web: 分布式 sing-box 管理平台技术设计文档

## 1. 项目概述 (Project Overview)

`sing-box-web` 是一个旨在实现对分布式部署的 `sing-box` 实例进行统一管理的平台。它允许管理员通过 Web 界面，对部署在不同节点（物理机、虚拟机、容器等）上的 `sing-box` 服务进行配置的增删改查（CURD）操作，并实时监控各节点的系统资源状态。

### 核心功能 (Core Features)

- **多节点统一管理**: 集中管理和查看所有 `sing-box` 节点的状态。
- **配置远程分发**: 在 Web 端修改配置后，可以一键将配置下发到指定的单个或多个节点，并使其生效。
- **节点状态监控**: 实时监控节点的 CPU、内存、磁盘使用率以及网络 I/O 等关键指标。
- **高可扩展性**: 采用 Agent 模式，方便新节点的接入和扩展。

### 架构模式 (Architectural Pattern)

本项目将采用 C/S (Client/Server) 与 B/S (Browser/Server) 相结合的混合架构模式，以发挥各自的优势。
- **C/S 模式**: 用于管理平台 (`Manager`) 与节点代理 (`Agent`) 之间的通信。
- **B/S 模式**: 用于管理员用户通过浏览器与管理平台 (`Manager`) 进行交互。

---

## 2. 经典架构分析 (Analysis of Classic Architectures)

为了更好地设计 `sing-box-web`，我们分析两个优秀的 Go 项目作为参考。

### 2.1. frp (C/S 模式)

`frp` 是一个高性能的反向代理应用，其典型的 C/S 架构非常值得借鉴。

- **组件**: `frps` (服务端) 和 `frpc` (客户端)。
- **通信**: `frpc` 主动与 `frps` 建立一个持久化的 TCP 连接（控制连接），用于心跳、命令和状态的传递。当有流量需要转发时，会建立新的数据连接。
- **优点**:
    - **实时性**: 长连接保证了控制命令可以被实时、可靠地推送到客户端。
    - **高效率**: 通信协议经过精心设计，开销小，性能高。
- **启示**: `Manager` 与 `Agent` 之间的通信可以借鉴这种模式。`Agent` 主动连接 `Manager` 并维持一个长连接，用于接收配置更新指令和上报监控数据。

### 2.2. Karmada-Manager (B/S 模式)

`Karmada` 是一个多云多集群的 Kubernetes 管理系统，其 `Manager` (如果存在) 通常会采用 B/S 架构。

- **组件**: Web 前端 (Browser) + 后端 API 服务器 (Server)。
- **通信**: 前端通过 HTTP/HTTPS 协议调用后端提供的 RESTful API 来完成数据的增删改查和展示。
- **优点**:
    - **易用性**: 用户无需安装任何客户端软件，只需一个现代浏览器即可访问。
    - **跨平台**: Web 界面天然具有跨平台特性。
    - **关注点分离**: 前后端分离开发，便于独立迭代和维护。
- **启示**: 管理员与 `sing-box-web` 平台的交互应采用此模式，提供一个功能强大且用户友好的 Web UI。

---

## 3. `sing-box-web` 整体架构设计 (Overall Architecture Design)

结合以上分析，我们设计 `sing-box-web` 的混合架构。

### 3.1. 架构图 (Architecture Diagram)

```mermaid
graph TD
    subgraph 用户端 (Browser/Client-Side)
        User[<br>管理员<br>Admin User] --> Browser[<br>Web浏览器<br>Web Browser]
    end

    subgraph "sing-box-manager (管理平台/服务端)"
        Browser -- "HTTPS (REST API)" --> WebServer[<br>Web服务器<br>Gin/Echo]
        WebServer <--> DB[(<br>数据库<br>Database<br>PostgreSQL/SQLite)]
        WebServer -- "内部调用" --> RPCServer[<br>RPC服务器<br>gRPC Server]
    end

    subgraph "节点 (Node)"
        direction LR
        RPCServer -- "gRPC (双向流)" --> RPCAgent[<br>sing-box-agent<br>RPC Client]
        RPCAgent -- "系统调用" --> OSMetrics[<br>系统监控<br>CPU, Mem, Disk, Net]
        RPCAgent -- "文件读写/命令" --> SingBox[<br>sing-box 实例<br>sing-box Instance]
    end

    style User text-align:center
    style Browser text-align:center
    style WebServer text-align:center
    style DB text-align:center
    style RPCServer text-align:center
    style RPCAgent text-align:center
    style OSMetrics text-align:center
    style SingBox text-align:center
```

### 3.2. 核心组件 (Core Components)

#### 3.2.1. `sing-box-manager` (管理平台/服务端)

这是整个系统的控制中心，由两部分组成：

1.  **B/S 部分 (面向管理员)**:
    - **Web Server**: 基于 Go 的 Web 框架（如 Gin）实现，对外提供 RESTful API 接口，供前端调用。它负责处理用户请求、业务逻辑、身份认证、数据存储等。
    - **Web UI**: 基于现代前端框架（如 Vue/React）构建的单页应用 (SPA)，为管理员提供可视化的操作界面。

2.  **C/S 部分 (面向 Agent)**:
    - **RPC Server**: 基于 gRPC 实现，监听特定端口，接收来自各个 `sing-box-agent` 的连接。它负责向 Agent 推送配置指令，并接收 Agent 上报的心跳和监控数据。

#### 3.2.2. `sing-box-agent` (节点代理/客户端)

这是一个轻量级的代理程序，需要部署在每一台运行 `sing-box` 的机器上。

1.  **RPC Client**: 主动连接 `Manager` 的 RPC Server 并保持长连接。如果连接断开，会自动重连。
2.  **监控模块 (Monitoring Module)**: 定期采集所在节点的系统资源信息（CPU、内存、磁盘、网络），并通过 RPC 连接上报给 `Manager`。
3.  **配置管理器 (Configuration Manager)**: 接收 `Manager` 下发的配置更新指令，负责安全地写入 `sing-box` 的配置文件，并执行 reload 或 restart 命令使配置生效。
4.  **心跳机制 (Heartbeat)**: 定期向 `Manager` 发送心跳，以表明自身存活状态。

---

## 4. 通信协议设计 (Communication Protocol Design)

### 4.1. Manager-Agent 通信 (gRPC)

选用 gRPC 是因为它基于 HTTP/2，使用 Protocol Buffers 进行序列化，性能高、支持双向流，且类型安全。

**服务定义 (Protobuf)**:

```protobuf
syntax = "proto3";

package agent;

// Agent -> Manager
service AgentService {
  // Agent 注册和心跳
  rpc Register(stream HeartbeatRequest) returns (stream CommandResponse);
}

message HeartbeatRequest {
  string node_id = 1;      // 节点唯一ID，可以是机器码或许可证
  string node_ip = 2;
  Metrics metrics = 3;     // 实时监控数据
}

message Metrics {
  float cpu_usage = 1;     // CPU 使用率 (%)
  int64 memory_total = 2;  // 总内存 (bytes)
  int64 memory_used = 3;   // 已用内存 (bytes)
  int64 disk_total = 4;    // 总磁盘 (bytes)
  int64 disk_used = 5;     // 已用磁盘 (bytes)
  int64 net_tx = 6;        // 上传流量 (bytes/s)
  int64 net_rx = 7;        // 下载流量 (bytes/s)
}

// Manager -> Agent
message CommandResponse {
  enum CommandType {
    GET_CONFIG = 0;
    UPDATE_CONFIG = 1;
  }
  CommandType type = 1;
  string payload = 2; // 根据指令类型，可以是空或配置文件内容
}
```
*通过双向流，可以在一个连接上实现心跳上报和指令下发。*

### 4.2. Browser-Manager 通信 (RESTful API)

使用标准的 RESTful API，通过 HTTP/S 协议进行通信，返回 JSON 格式数据。

**核心 API 端点示例**:

- `GET /api/v1/nodes`: 获取所有已注册的节点列表及其最新状态。
- `GET /api/v1/nodes/{node_id}`: 获取单个节点的详细信息。
- `GET /api/v1/nodes/{node_id}/metrics`: 获取指定节点一段时间内的历史监控数据。
- `GET /api/v1/nodes/{node_id}/config`: 获取指定节点的当前 `sing-box` 配置。
- `POST /api/v1/nodes/{node_id}/config`: 更新指定节点的 `sing-box` 配置。
- `POST /api/v1/auth/login`: 管理员登录。

---

## 5. 技术选型 (Technology Stack)

- **后端 (Backend)**: Go
- **RPC 框架**: gRPC
- **Web 框架**: Gin
- **数据库**: PostgreSQL (功能强大) 或 SQLite (轻量、易部署)
- **前端 (Frontend)**: Vue 3 + Vite + TypeScript
- **UI 库**: Element Plus / Ant Design Vue
- **监控数据可视化**: ECharts

---

## 6. 权衡与考量 (Trade-offs and Considerations)

- **安全性**: `Manager` 与 `Agent` 之间的通信必须加密（gRPC 天然支持 TLS）。可以增加一个 Token 机制，只有合法的 Agent 才能注册到 `Manager`。Web 端需要有完善的登录认证和权限控制。
- **可靠性**: Agent 必须具备断线重连和守护进程机制，确保其自身的高可用性。`Manager` 下发配置后，应有状态回报机制，确认 Agent 是否成功应用。
- **部署**: `Manager` 可以容器化部署。`Agent` 需要提供简单的安装脚本，并能方便地注册到 `Manager` 地址。

### 结论

通过融合 C/S 和 B/S 架构，`sing-box-web` 可以在保证控制实时性和高效性的同时，为管理员提供一个功能丰富、易于访问的管理界面。该设计方案在`frp`的高效通信和`Karmada-Manager`的用户友好性之间取得了平衡，能够很好地满足项目的核心需求。
