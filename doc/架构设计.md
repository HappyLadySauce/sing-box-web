### 分布式 sing-box 管理平台精简架构设计（适配低配置节点 + SkyWalking 统一集成 + Logrus 日志）

---

#### **一、核心目标**  
在 **1C1G 低配置节点** 环境下，实现 **轻量级、高可用** 的 sing-box 分布式管理平台，核心功能包括：节点配置 CRU（增删改查）、节点监控（CPU/内存/磁盘/网络 IO）、用户流量与套餐管理、Clash API 数据集成。架构采用 **B/S（前端）+ C/S（后端服务）** 混合模式，通过 **SkyWalking 统一无侵入集成** 实现全链路监控，日志使用 **Logrus** 结构化输出，降低资源占用。

---

### **二、整体架构概览**  
```mermaid
graph TD
    subgraph 前端层
        Frontend[用户浏览器] -->|HTTP| WebServer[sing-box-web]
    end

    subgraph 应用层
        WebServer -->|gRPC| APIserver[sing-box-api]
        APIserver -->|gRPC| Agent1[sing-box-agent@节点1]
        APIserver -->|gRPC| Agent2[sing-box-agent@节点2]
        APIserver -->|gRPC| AgentN[sing-box-agent@节点N]
    end

    subgraph 数据层
        MySQL[用户/套餐/流量/日志/配置元数据] <--> WebServer
        MinIO[配置文件存储] <--> Agent1 & Agent2 & AgentN
    end

    subgraph 监控观测层
        SkyWalkingCollector[SkyWalking 采集器] <--|HTTP/gRPC| WebServer & APIserver & Agent1 & Agent2 & AgentN
        SkyWalkingUI[Kibana] <--|数据| SkyWalkingCollector
        Filebeat[日志收集] <--|文件| WebServer & APIserver & Agent1 & Agent2 & AgentN --> Elasticsearch[日志存储]
    end
```

---

### **三、核心模块设计（轻量化适配）**  

#### **1. 前端（B/S 模式）**  
- **功能**：用户交互入口，提供节点管理（增删改查）、配置编辑、监控看板（CPU/内存/流量）、套餐管理与用户订阅、操作日志查询。  
- **技术栈**：Vue 3（轻量渲染）+ Axios（HTTP 客户端）+ ECharts（轻量图表）。  
- **优化**：  
  - 前端资源压缩（JS/CSS 树摇），减少首屏加载时间。  
  - 监控数据通过 **WebSocket 长连接** 按需拉取（避免轮询资源浪费）。  

---

#### **2. sing-box-web（Web 后端）**  
- **功能**：用户认证（JWT）、权限控制（RBAC）、套餐与订阅管理、流量统计与状态管理（定时任务）、操作日志记录（Logrus）、请求转发至 `sing-box-api`。  
- **技术栈**：Go 1.23（轻量运行时）+ Gin（低内存 Web 框架）+ GORM（轻量 ORM）+ Logrus（结构化日志）+ SkyWalking Go Agent（无侵入）。  
- **轻量化设计**：  
  - 禁用 Gin 冗余中间件（如日志默认中间件，改用 Logrus 自定义日志）。  
  - 连接池复用（数据库、Redis），减少资源开销。  
- **日志**：使用 Logrus 输出结构化日志（JSON 格式），包含 `user_id`、`operation`、`duration` 等字段，写入本地文件后由 Filebeat 收集。  

---

#### **3. sing-box-api（RPC 协调器）**  
- **功能**：节点操作协调（配置下发、服务重启）、接收 Agent 上报的用户流量数据、执行用户启用/禁用/移除指令、Clash API 数据聚合（流量/客户端数）。  
- **技术栈**：Go 1.23 + gRPC（轻量 RPC 框架）+ SkyWalking Go Agent（无侵入）。  
- **轻量化设计**：  
  - gRPC 服务端配置简化（禁用不必要的拦截器，仅保留必要压缩）。  
  - 下游调用超时控制（默认 5s），避免长时间阻塞。  
- **日志**：集成 Logrus，记录关键操作（如“节点 X 配置下发成功”），日志级别动态调整（生产环境 `INFO`，调试环境 `DEBUG`）。  

---

#### **4. sing-box-agent（节点代理）**  
- **功能**：部署在 1C1G 节点上，执行配置下发、服务管理（`systemctl`）、监控数据采集（CPU/内存/磁盘/网络 IO）、从 sing-box API 定期获取用户流量并上报、执行用户管理指令（增/删/改）、Clash API 数据获取。  
- **技术栈**：Go 1.23（编译为静态二进制，无依赖）+ Cobra（轻量 CLI）+ Prometheus Client（轻量指标暴露）+ SkyWalking Go Agent（无侵入）。  
- **轻量化设计**：  
  - 监控采集频率降低（CPU/内存每 30s 采集一次，磁盘/网络每 60s 采集一次）。  
  - 配置下发采用“原子替换”（`mv tmp.conf box.conf`），避免写锁占用。  
  - Clash API 调用缓存（每 5min 缓存一次，在线客户端数、总流量），减少本地 API 调用次数。  
- **日志**：Logrus 输出到本地文件（`/var/log/sing-box-agent.log`），级别 `ERROR`（仅记录异常），避免日志量过大。  

---

### **四、用户流量与套餐管理**
为了实现对终端用户的精细化管理和商业化运营，引入用户流量和节点套餐管理功能。

#### **1. 数据模型设计**
在 `MySQL` 数据库中增加核心表：

- **`plans` (套餐表)**
  - `id`: 主键
  - `name`: 套餐名称（如 "月付-100G"）
  - `traffic_limit_bytes`: 流量限制（单位：Bytes）
  - `duration_days`: 套餐有效期（单位：天）
  - `price`: 价格
  - `is_enabled`: 是否启用

- **`subscriptions` (用户订阅表)**
  - `id`: 主键
  - `user_id`: 用户 ID (关联 `users` 表)
  - `plan_id`: 套餐 ID (关联 `plans` 表)
  - `start_time`: 订阅开始时间
  - `end_time`: 订阅到期时间
  - `traffic_used_bytes`: 已用流量
  - `traffic_total_bytes`: 总流量（冗余字段，来自 `plans`）
  - `status`: 订阅状态（`active`, `expired`, `suspended`）

#### **2. 核心业务流程**

1.  **订阅流程**:
    - 管理员在 `sing-box-web` 后台为用户关联一个套餐，创建一条 `active` 状态的 `subscriptions` 记录。
    - `sing-box-web` 调用 `sing-box-api`，传递用户信息和节点分配信息。
    - `sing-box-api` 向相关节点上的 `sing-box-agent` 发送指令，`agent` 负责修改 `sing-box` 配置文件，添加该用户并重载服务使其生效。

2.  **流量统计**:
    - `sing-box-agent` 定期（如每 5 分钟）通过 `sing-box` 的 API 接口查询每个用户的出站流量数据。
    - `agent` 将流量增量数据上报给 `sing-box-api`。
    - `sing-box-api` 接收到数据后，请求 `sing-box-web` 的内部 API，在数据库中更新对应 `subscriptions` 记录的 `traffic_used_bytes` 字段。

3.  **流量超限与到期处理**:
    - `sing-box-web` 中有一个定时任务（如每分钟执行一次），扫描 `subscriptions` 表。
    - **检查超限**: 如果 `traffic_used_bytes` >= `traffic_total_bytes`，则将订阅状态更新为 `suspended`。
    - **检查到期**: 如果当前时间 > `end_time`，则将订阅状态更新为 `expired`。
    - 状态变更后，`sing-box-web` 调用 `sing-box-api`，由 `api` 通知 `agent` 从 `sing-box` 配置中移除或禁用相关用户。

---

### **五、SkyWalking 统一无侵入集成**  
**目标**：在低配置节点上实现 **全链路监控**，同时最小化资源占用（CPU < 2%，内存 < 50MB）。  

#### **1. 部署架构**  
- **SkyWalking Collector**：独立部署（单节点即可），接收各服务上报的调用链、指标、日志。  
- **服务发现**：静态配置（无 Consul），各服务 Agent 通过配置文件指定下游服务地址。  

#### **2. 静态服务发现配置（示例）**  
- **sing-box-web 的 Agent 配置（`agent.config`）**  
  ```yaml
  service_name: "sing-box-web"
  collector_backend_services: ["http://skywalking-collector:11800"]  # Collector 地址（局域网内）
  [grpc]
  [[grpc.service]]
  name: "sing-box.api.v1.SingBoxAPI"  # 与 Protobuf 服务名一致
  endpoint: "127.0.0.1:50051"         # sing-box-api 本地地址（低配置节点无公网 IP）
  ```

- **sing-box-api 的 Agent 配置（`agent.config`）**  
  ```yaml
  service_name: "sing-box-api"
  collector_backend_services: ["http://skywalking-collector:11800"]
  [grpc]
  [[grpc.service]]
  name: "sing-box.agent.v1.SingBoxAgent"
  endpoint: "192.168.1.100:50052"  # 节点 1 的 sing-box-agent 地址（局域网内）
  [[grpc.service]]
  name: "sing-box.agent.v1.SingBoxAgent"
  endpoint: "192.168.1.101:50052"  # 节点 2 的 sing-box-agent 地址
  ```

#### **3. 无侵入实现**  
- **代码零修改**：SkyWalking Agent 自动拦截 HTTP/gRPC 调用，生成调用链 Span（记录请求路径、耗时、下游服务）。  
- **轻量级采集**：Agent 配置中关闭非必要功能（如 Java 自动探针、性能剖析），仅保留 Go 基础追踪。  

#### **4. 监控数据展示**  
- **调用链**：SkyWalking UI 查看“用户登录 → 配置下发 → 节点响应”全链路，定位慢节点（如 `APIserver → Agent` 耗时 > 2s）。  
- **节点指标**：Prometheus + Grafana 展示 CPU/内存/磁盘使用率（1C1G 节点建议阈值：CPU < 80%，内存 < 70%）。  
- **Clash 数据**：通过 `sing-box-api` 聚合后展示在线客户端数、今日流量（避免直接访问节点本地 API）。  

---

### **六、Logrus 日志设计（低配置适配）**  
- **日志格式**：结构化 JSON（包含 `level`、`msg`、`time`、`service`、`node_id` 等字段），便于日志分析。  
- **日志级别**：  
  - `sing-box-web`/`sing-box-api`：`INFO`（生产环境），记录用户操作、关键业务逻辑。  
  - `sing-box-agent`：`ERROR`（生产环境），仅记录系统调用失败（如 `systemctl reload` 失败）、配置解析错误。  
- **日志存储**：  
  - 本地文件（`/var/log/[service].log`），通过 `logrotate` 定期切割（每日切割，保留 7 天）。  
  - Filebeat 收集后发送至 Elasticsearch（轻量级配置，仅索引关键字段）。  

---

### **七、低配置节点优化策略**  
1. **资源限制**：  
   - `sing-box-agent` 编译为静态二进制（无依赖），内存占用 < 20MB（空闲状态）。  
   - `sing-box-web`/`sing-box-api` 启动时限制 CPU 核心（`GOMAXPROCS=1`），避免抢占节点资源。  
2. **采集频率**：  
   - 监控数据采集间隔延长（CPU/内存 30s，磁盘/网络 60s），减少 Agent 资源消耗。  
   - Clash API 数据缓存（5min），避免频繁调用本地服务。  
3. **连接优化**：  
   - 数据库使用连接池（最大 5 连接），减少 MySQL 资源占用。  
   - gRPC 调用启用压缩（`gzip`），降低网络带宽消耗。  

---

### **八、总结**  
本架构通过 **轻量化技术选型**（Go、Logrus、静态编译）、**SkyWalking 统一无侵入集成**（静态服务发现、最小化采集）、**低配置节点优化**（资源限制、采集频率调整），实现了在 1C1G 节点上的高效运行。核心优势：  
- **低资源占用**：各组件内存占用 < 100MB，CPU 占用 < 5%（空闲状态）。  
- **强可观测性**：SkyWalking 提供全链路监控，Logrus 结构化日志便于问题排查。  
- **易部署**：静态二进制、无依赖组件，支持快速批量部署至节点。

---

### 九、进阶功能规划 (Advanced Feature Planning)
为了构建一个功能全面、自动化程度高的商业级机场管理平台，可在当前架构基础上扩展以下进阶功能：

#### 1. 进阶机场管理功能

- **订阅与客户端支持**:
  - **通用订阅链接生成**: 提供兼容主流客户端（Clash, V2RayN, Shadowrocket 等）的订阅地址。
  - **一键配置下发**: 支持生成二维码、URI 等，方便用户快速导入配置到客户端。
  - **审计日志**: 详细记录管理员和用户的关键操作，便于安全审计和问题追溯。

#### 2. 进阶节点管理功能

- **自动化与策略管理**:
  - **节点标签与分组**: 为节点打上标签（如 `地区:香港`, `用途:流媒体`, `倍率:1.5x`），实现对节点的精细化分组和权限控制。
  - **智能策略路由**: 基于节点标签，为不同等级的用户套餐分配不同的节点访问权限。
  - **节点健康巡检**: 除了基础资源监控，增加对节点的连通性、延迟、流媒体解锁状态的自动化检测。
  - **故障自动转移**: 当检测到某个节点故障时，可自动将其从可用节点列表中暂时移除，并通知管理员。

- **安全与批量运维**:
  - **节点防火墙管理**: 在 Web 界面上统一管理节点防火墙规则，快速封禁恶意 IP 或屏蔽特定端口流量（如 BitTorrent）。
  - **批量命令/脚本执行**: 支持对指定分组的节点批量执行 Shell 命令或预设脚本，提高运维效率。
  - **资源阈值告警**: 设定 CPU、内存、流量等资源的告警阈值，当节点达到阈值时通过邮件或即时通讯工具（如 Telegram Bot）发送告警。
